name: Vercel Serverless Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Validate serverless entry point
      run: node -c src/index-serverless.js
    
    - name: Validate Vercel configuration
      run: |
        echo "ğŸ” Validating Vercel serverless deployment..."
        
        # Check vercel.json exists and is valid
        if [ ! -f vercel.json ]; then
          echo "âŒ vercel.json not found"
          exit 1
        fi
        echo "âœ… vercel.json exists"
        
        # Check serverless entry point exists
        if [ ! -f src/index-serverless.js ]; then
          echo "âŒ src/index-serverless.js not found"
          exit 1
        fi
        echo "âœ… Serverless entry point exists"
        
        # Validate vercel.json references correct serverless file
        if ! grep -q "src/index-serverless.js" vercel.json; then
          echo "âŒ vercel.json doesn't reference src/index-serverless.js"
          exit 1
        fi
        echo "âœ… vercel.json properly configured for serverless"
        
        # Show current configuration
        echo "ğŸ“‹ Current vercel.json configuration:"
        cat vercel.json
        
        echo ""
        echo "ğŸ¯ Deployment target: Vercel Serverless Functions"
        echo "ğŸ“ Entry point: src/index-serverless.js"
        echo "ğŸš« File operations: Removed for serverless compatibility"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Vercel CLI
      run: npm install --global vercel@latest
    
    - name: Deploy to Vercel
      if: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ğŸš€ Deploying HexSyn Server to Vercel..."
        vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    
    - name: Deployment Success
      if: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "âœ… HexSyn Server deployed successfully!"
        echo ""
        echo "ğŸŒ Production URL: https://hexsyn-server.vercel.app"
        echo "ğŸ”— API Endpoints:"
        echo "   â€¢ Health: https://hexsyn-server.vercel.app/api/health"
        echo "   â€¢ Email: https://hexsyn-server.vercel.app/api/email/send-application"
        echo "   â€¢ SMTP Test: https://hexsyn-server.vercel.app/api/email/test-connection"
        echo ""
        echo "ğŸ” Monitor: https://vercel.com/dashboard"
    
    - name: Setup Instructions
      if: ${{ !secrets.VERCEL_TOKEN }}
      run: |
        echo "âš ï¸ Automatic deployment skipped - Vercel secrets not configured"
        echo ""
        echo "ğŸ”§ To enable GitHub Actions â†’ Vercel deployment:"
        echo "1. Get Vercel Token: https://vercel.com/account/tokens"
        echo "2. Go to: GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions"
        echo "3. Add these secrets:"
        echo "   â€¢ VERCEL_TOKEN"
        echo "   â€¢ VERCEL_ORG_ID (from .vercel/project.json)"
        echo "   â€¢ VERCEL_PROJECT_ID (from .vercel/project.json)"
        echo ""
        echo "ğŸš€ Manual deployment: vercel --prod"
        echo "ğŸ“‹ Current status: Validation passed, ready for deployment"
